<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Campus Pulse</title>
    <link rel="icon" type="image/png" href="./favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-5">
    <h1 class="text-3xl font-bold text-center mb-8">Campus Pulse</h1>

<button onclick="openAdminModal()" class="fixed top-5 right-5 bg-gray-800 text-white p-2 rounded text-sm">
    Admin Login
</button>

  <div id="admin-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
        <h2 class="text-xl font-bold mb-4">Admin Login</h2>
        <input type="password" id="admin-password" placeholder="Enter Password" class="w-full border p-2 mb-4 rounded">
        <div class="flex gap-2">
            <button onclick="closeModal()" class="w-full bg-gray-300 p-2 rounded">Cancel</button>
            <button onclick="verifyAdmin()" class="w-full bg-blue-600 text-white p-2 rounded">Login</button>
        </div>
    </div>
</div>

    <div id="form-container">
    <div class="bg-white p-6 rounded shadow max-w-md mx-auto">
        <select id="location" class="w-full border p-2 mb-3 rounded">
            <option>Library</option>
            <option>Canteen</option>
            <option>CS</option>
            <option>Mech</option>
            <option>Civil</option>
            <option>EEE</option>
            <option>AEI</option>
            <option>EC</option>
            <option>Industrial</option>
            <option>EL</option>
            <option>MCA</option>
            <option>PyhsicalEducation</option>
        </select>

     <select id="category" class="w-full border p-2 mb-3 rounded">
    <option value="" disabled selected>Select Category</option>
    <option>Maintenance</option>
    <option>Internet</option>
    <option>Cleanliness</option>
    <option>Safety</option>
    <option>Sanitary</option>
     <option>Other</option>

    
    </select>

        <textarea id="description" placeholder="What's the issue?" class="w-full border p-2 mb-3 rounded"></textarea>
        <button onclick="saveIssue()" class="w-full bg-blue-600 text-white p-2 rounded">Submit Issue</button>
    </div>
    </div>

    <div id="admin-filter" class="hidden max-w-md mx-auto mb-6">
    <input type="text" id="filter-input" onkeyup="refreshAdminView()" 
           placeholder="ðŸ” Search category (e.g., Internet, Safety)..." 
           class="w-full border-2 border-blue-500 p-3 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
   </div>

    <div id="feedback-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 p-4">
    </div>

    <script type="module">
    // 1. IMPORTS
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

    // 2. FIREBASE CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyAB-nrFjOenLR1in99KNGcn0u_EvPrO5KQ",
        authDomain: "campuspulse-c2b3d.firebaseapp.com",
        projectId: "campuspulse-c2b3d",
        storageBucket: "campuspulse-c2b3d.firebasestorage.app",
        messagingSenderId: "170661187917",
        appId: "1:170661187917:web:23e1ecd329bf7bd8fb6704"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 3. GLOBAL VARIABLES
    const ADMIN_SECRET = "campus123";
    let isAdmin = false;
    let currentSnapshot = null;

    // 4. LIVE LISTENER
    onSnapshot(query(collection(db, "feedbacks"), orderBy("timestamp", "desc")), (snapshot) => {
        currentSnapshot = snapshot;
        renderFeed(snapshot);
    });

    // 5. FUNCTIONS
    window.openAdminModal = () => {
        document.getElementById('admin-modal').classList.remove('hidden');
    };

    window.closeModal = () => {
        document.getElementById('admin-modal').classList.add('hidden');
    };

    window.verifyAdmin = () => {
    const password = document.getElementById('admin-password').value;
    if (password === ADMIN_SECRET) {
        isAdmin = true;
        document.getElementById('form-container').style.display = 'none';
        
        // SHOW THE FILTER BAR
        document.getElementById('admin-filter').classList.remove('hidden'); 
        
        document.getElementById('admin-modal').classList.add('hidden');
        if (currentSnapshot) renderFeed(currentSnapshot);
        showNotification("Welcome, Admin!");
    } else {
        showNotification("Invalid Password!", true);
    }
};

    window.saveIssue = async () => {
        const loc = document.getElementById('location').value;
        const cat = document.getElementById('category').value;
        const desc = document.getElementById('description').value;

        if (!cat) { 
            showNotification("Please select a category!", true); 
            return; 
        }

        await addDoc(collection(db, "feedbacks"), { 
            location: loc, 
            category: cat, 
            description: desc, 
            status: "pending", 
            timestamp: new Date() 
        });
        showNotification("Issue submitted successfully!");
    };

   window.renderFeed = (snapshot) => {
    const list = document.getElementById('feedback-list');
    // Get the search value from the input field
    const filterInput = document.getElementById('filter-input');
    const filter = filterInput ? filterInput.value.toLowerCase() : "";
    
    list.innerHTML = "";
    
    snapshot.forEach(doc => {
        const data = doc.data();
        const category = (data.category || "").toLowerCase(); // Get category safely
        const currentStatus = data.status || 'pending';

        // --- THE FILTER LOGIC STARTS HERE ---
        // If the user typed something, AND it doesn't match the category, skip this card
        if (filter && !category.includes(filter)) {
            return; // Stops this specific loop iteration and goes to the next card
        }
        // --- THE FILTER LOGIC ENDS HERE ---

        const pBtn = currentStatus === 'pending' ? 'bg-gray-600 text-white' : 'bg-gray-100 text-gray-400';
        const iBtn = currentStatus === 'in-progress' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-400';
        const rBtn = currentStatus === 'resolved' ? 'bg-red-600 text-white' : 'bg-gray-100 text-gray-400';

        const adminControls = isAdmin 
            ? `<div class="mt-4 flex gap-2">
                <button onclick="updateStatus('${doc.id}', 'pending')" class="text-xs px-3 py-1 rounded font-bold ${pBtn}">Pending</button>
                <button onclick="updateStatus('${doc.id}', 'in-progress')" class="text-xs px-3 py-1 rounded font-bold ${iBtn}">In Progress</button>
                <button onclick="updateStatus('${doc.id}', 'resolved')" class="text-xs px-3 py-1 rounded font-bold ${rBtn}">Resolved</button>
              </div>` 
            : "";

        list.innerHTML += `
            <div class="bg-white p-6 mb-4 rounded-xl shadow-sm border border-gray-200">
                <div class="flex justify-between items-start mb-3">
                    <span class="text-[10px] font-bold uppercase text-blue-600 bg-blue-50 px-2 py-1 rounded">${data.category}</span>
                    <span class="text-gray-400 text-xs">${data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleDateString() : 'Just now'}</span>
                </div>
                <h3 class="text-xl font-bold text-gray-800">${data.location}</h3>
                <p class="text-gray-600 mt-2 text-sm">${data.description}</p>
                
                <div class="mt-4 flex items-center justify-between">
                     <span class="text-[10px] font-bold uppercase text-gray-500">Status: ${currentStatus}</span>
                     ${adminControls}
                </div>
            </div>`;
    });
};

// Add this helper to force a refresh when typing
window.refreshAdminView = () => {
    if (currentSnapshot) renderFeed(currentSnapshot);
};

    window.updateStatus = async (id, newStatus) => {
        try {
            const issueRef = doc(db, "feedbacks", id);
            await updateDoc(issueRef, { status: newStatus });
            showNotification("Status updated to: " + newStatus);
        } catch (error) {
            console.error("Error updating document: ", error);
            showNotification("Failed to update status.", true);
        }
    };

    window.showNotification = (message, isError = false) => {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        toastMessage.textContent = message;
        toast.className = `fixed top-5 right-5 z-50 p-4 rounded-lg shadow-2xl text-white font-bold transition-all duration-300 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
        toast.classList.remove('hidden');
        setTimeout(() => { toast.classList.add('hidden'); }, 3000);
    };
</script>
<div id="toast" class="hidden fixed top-5 right-5 z-50 p-4 rounded-lg shadow-2xl text-white font-bold transition-all duration-300">
    <span id="toast-message"></span>
</div>
    </body>
    </html>